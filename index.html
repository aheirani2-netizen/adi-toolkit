<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ADI Reflective Log</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
body { font-family: Arial; padding:20px; max-width:900px; margin:auto; background:#f4f4f4; }
h1{text-align:center;}
input,textarea,select{width:100%;padding:10px;margin-bottom:15px;border-radius:8px;border:1px solid #ccc;font-size:16px;}
textarea{min-height:80px;}
button{width:100%;padding:12px;margin-top:10px;border:none;border-radius:8px;font-size:16px;cursor:pointer;background:#111;color:white;}
.scale-bar{display:flex;margin-bottom:15px;}
.scale-bar div{flex:1;padding:8px;text-align:center;color:white;font-weight:bold;cursor:pointer;}
.scale-bar div:nth-child(-n+3){background:#d32f2f;}
.scale-bar div:nth-child(n+4):nth-child(-n+6){background:#fbc02d;color:black;}
.scale-bar div:nth-child(n+7){background:#2e7d32;}
.selected{outline:3px solid black;}
.pupil-bar{display:flex;gap:8px;margin-bottom:15px;}
.pupil-bar select{flex:2;}
.pupil-bar button{flex:1;}
.total-hours{font-weight:bold;margin-bottom:15px;}
.hidden-print{display:block;}
</style>
</head>

<body>

<div id="formArea">

<h1>LEARNER REFLECTIVE LOG</h1>
<p><strong>Instructor:</strong> Alex Heirani</p>
<p><strong>Date:</strong> <span id="date"></span></p>

<div class="pupil-bar hidden-print">
<select id="pupilSelect"></select>
<button onclick="addPupil()">Add</button>
<button onclick="deletePupil()">Delete</button>
</div>

<p class="total-hours">Total Hours: <span id="totalHours">0</span></p>

<label class="hidden-print">Lesson Duration (hours):</label>
<input class="hidden-print" type="number" step="0.5" id="lessonHours">

<label>Lesson Goal:</label>
<textarea id="goal"></textarea>

<label>Initial Self Rating:</label>
<div class="scale-bar" id="scale1"></div>

<label>What didnâ€™t go well?</label>
<textarea id="improve"></textarea>

<label>What could you do differently?</label>
<textarea id="different"></textarea>

<label>What went well?</label>
<textarea id="well"></textarea>

<label>Did you achieve the goal?</label>
<textarea id="achieved"></textarea>

<label>Final Self Rating:</label>
<div class="scale-bar" id="scale2"></div>

<label>Additional Comments:</label>
<textarea id="comments"></textarea>

<div class="hidden-print">
<button onclick="generateLessonPDF()">Generate Lesson PDF</button>
<button onclick="exportHistoryPDF()">Export Full Pupil Progress</button>
</div>

</div>

<script>
document.getElementById("date").innerText =
new Date().toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'});

let pupils = JSON.parse(localStorage.getItem("adiPupilsV3")) || {};
let currentPupil = null;

function save(){ localStorage.setItem("adiPupilsV3", JSON.stringify(pupils)); }

function loadDropdown(){
let select=document.getElementById("pupilSelect");
select.innerHTML="";
let names=Object.keys(pupils);

if(names.length===0){currentPupil=null;document.getElementById("totalHours").innerText="0";return;}

names.forEach(name=>{
let opt=document.createElement("option");
opt.value=name;
opt.text=name;
select.appendChild(opt);
});

if(!currentPupil || !pupils[currentPupil]) currentPupil=names[0];
select.value=currentPupil;
updateDisplay();
}

function addPupil(){
let name=prompt("Enter pupil name:");
if(!name) return;
if(!pupils[name]) pupils[name]={hours:0,lessons:[]};
currentPupil=name;
save();
loadDropdown();
}

function deletePupil(){
if(!currentPupil) return;
if(confirm("Delete "+currentPupil+"?")){
delete pupils[currentPupil];
save();
currentPupil=null;
loadDropdown();
}
}

document.getElementById("pupilSelect").addEventListener("change",function(){
currentPupil=this.value;updateDisplay();
});

function updateDisplay(){
if(!currentPupil) return;
document.getElementById("totalHours").innerText=pupils[currentPupil].hours;
}

function createScale(id){
for(let i=1;i<=10;i++){
let div=document.createElement("div");
div.innerText=i;
div.onclick=function(){
[...this.parentElement.children].forEach(c=>c.classList.remove("selected"));
this.classList.add("selected");
this.parentElement.setAttribute("data-value",i);
};
document.getElementById(id).appendChild(div);
}}
createScale("scale1");
createScale("scale2");

function saveLessonData(){
let hours=parseFloat(document.getElementById("lessonHours").value)||0;
let lesson={date:date.innerText,hours:hours};
pupils[currentPupil].hours+=hours;
pupils[currentPupil].lessons.push(lesson);
save();
updateDisplay();
}

async function generateLessonPDF(){
if(!currentPupil){alert("Select a pupil first.");return;}
saveLessonData();

let buttons=document.querySelectorAll(".hidden-print");
buttons.forEach(b=>b.style.display="none");

const { jsPDF } = window.jspdf;
let canvas = await html2canvas(document.getElementById("formArea"),{scale:2});
let pdf = new jsPDF("p","mm","a4");

let pageWidth = pdf.internal.pageSize.getWidth();
let pageHeight = pdf.internal.pageSize.getHeight();

let imgWidth = pageWidth;
let imgHeight = canvas.height * imgWidth / canvas.width;

let pageCanvas = document.createElement("canvas");
let ctx = pageCanvas.getContext("2d");

let pageHeightPx = canvas.width * pageHeight / pageWidth;
let totalPages = Math.ceil(canvas.height / pageHeightPx);

for(let i=0;i<totalPages;i++){
pageCanvas.width = canvas.width;
pageCanvas.height = pageHeightPx;

ctx.fillStyle = "white";
ctx.fillRect(0,0,pageCanvas.width,pageCanvas.height);
ctx.drawImage(canvas,0,i*pageHeightPx,canvas.width,pageHeightPx,0,0,canvas.width,pageHeightPx);

if(i>0) pdf.addPage();
pdf.addImage(pageCanvas.toDataURL("image/png"),"PNG",0,0,imgWidth,pageHeight);
}

pdf.save("Lesson_"+currentPupil+".pdf");

buttons.forEach(b=>b.style.display="block");
}

function exportHistoryPDF(){
if(!currentPupil){alert("Select a pupil first.");return;}
const { jsPDF } = window.jspdf;
let pdf=new jsPDF();
let y=20;
pdf.text("Full Progress - "+currentPupil,15,10);

pupils[currentPupil].lessons.forEach((l,i)=>{
pdf.text(`Lesson ${i+1} - ${l.date} - ${l.hours} hrs`,15,y);
y+=10;
if(y>270){pdf.addPage();y=20;}
});
pdf.save("Progress_"+currentPupil+".pdf");
}

loadDropdown();
</script>

</body>
</html>