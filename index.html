<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ADI Reflective Log</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
body { font-family: Arial,sans-serif; padding:20px; max-width:900px; margin:auto; background:#f4f4f4; line-height:1.5; }
h1 { text-align:center; margin-bottom:20px; }
input, textarea, select { width:100%; padding:10px; margin-bottom:15px; border-radius:8px; border:1px solid #ccc; font-size:16px; box-sizing:border-box; background:white; }
textarea { min-height:100px; resize:vertical; }
button { width:100%; padding:12px; margin:6px 0; border:none; border-radius:8px; font-size:15px; font-weight:bold; cursor:pointer; color:white; }
.save-btn { background:#1976d2; }
.email-btn { background:#2e7d32; }
.scale-bar { display:flex; gap:4px; margin-bottom:20px; }
.scale-bar div { flex:1; padding:8px; text-align:center; color:white; font-weight:bold; cursor:pointer; border-radius:6px; }
.scale-bar div:nth-child(-n+3) { background:#d32f2f; }
.scale-bar div:nth-child(n+4):nth-child(-n+6) { background:#fbc02d; color:black; }
.scale-bar div:nth-child(n+7) { background:#2e7d32; }
.selected { outline:3px solid #000; }
.pupil-bar { display:flex; gap:8px; margin-bottom:10px; }
.pupil-bar select { flex:3; }
.pupil-bar button { flex:1; }
.total-hours { font-weight:bold; font-size:1.1em; margin:8px 0; text-align:center; }
.section-label { margin-top:14px; margin-bottom:4px; font-weight:bold; }
.print-section { margin-bottom:8px; }
@media print {
    button, .pupil-bar { display:none !important; }
    body { background:white !important; font-size:13px !important; line-height:1.6 !important; }
    textarea { font-size:13px !important; line-height:1.65 !important; height:auto !important; overflow:hidden !important; padding:10px 10px 16px 10px !important; border:1px solid #999 !important; border-radius:6px !important; }
    @page { size:A4; margin:10mm; }
}
</style>
</head>
<body>

<h1>LEARNER REFLECTIVE LOG</h1>
<p><strong>Instructor:</strong> Alex Heirani</p>
<p><strong>Date:</strong> <span id="date"></span></p>

<div class="section-label">Student Name</div>
<div class="pupil-bar">
    <select id="pupilSelect"></select>
    <button onclick="addPupil()">Add</button>
    <button onclick="deletePupil()">Delete</button>
</div>

<p class="total-hours">Total Hours: <span id="totalHours">0</span></p>

<button class="save-btn" onclick="saveLesson()">Save Lesson</button>
<button class="email-btn" onclick="generatePDFandShare()">Send PDF via Email</button>

<div id="formArea">
<div class="print-section"><div class="section-label">Lesson Duration (hours)</div><input type="number" step="0.25" id="lessonHours" value="2"></div>
<div class="print-section"><div class="section-label">Lesson Goal</div><textarea id="goal"></textarea></div>
<div class="print-section"><div class="section-label">Initial Self Rating (1–10)</div><div class="scale-bar" id="scale1"></div></div>
<div class="print-section"><div class="section-label">What went well?</div><textarea id="well"></textarea></div>
<div class="print-section"><div class="section-label">What didn’t go well?</div><textarea id="improve"></textarea></div>
<div class="print-section"><div class="section-label">Did you achieve the goal?</div><textarea id="achieved"></textarea></div>
<div class="print-section"><div class="section-label">Final Self Rating (1–10)</div><div class="scale-bar" id="scale2"></div></div>
<div class="print-section"><div class="section-label">Additional Comments</div><textarea id="additional"></textarea></div>
</div>

<script>
document.getElementById("date").innerText = new Date().toLocaleDateString();

/* CREATE SCALES */
function createScale(id){
    const container=document.getElementById(id);
    for(let i=1;i<=10;i++){
        const div=document.createElement("div");
        div.innerText=i;
        div.onclick=()=>{[...container.children].forEach(c=>c.classList.remove("selected")); div.classList.add("selected");};
        container.appendChild(div);
    }
}
createScale("scale1"); createScale("scale2");

/* STORAGE */
let pupils=JSON.parse(localStorage.getItem("pupils")||"[]");
const pupilSelect=document.getElementById("pupilSelect");
function refreshPupils(){
    pupilSelect.innerHTML="";
    pupils.forEach((p,i)=>{
        const option=document.createElement("option");
        option.value=i; option.textContent=p.name;
        pupilSelect.appendChild(option);
    });
    updateHours();
}
refreshPupils();
function updateHours(){
    const index=pupilSelect.value;
    document.getElementById("totalHours").innerText=(pupils[index]&&pupils[index].totalHours)||0;
}
function getScaleValue(id){
    const sel=document.querySelector(`#${id} .selected`);
    return sel? sel.innerText : "";
}

/* SAVE LESSON */
function saveLesson(){
    const index=pupilSelect.value;
    if(index==="") return alert("Select a pupil.");
    const hours=parseFloat(document.getElementById("lessonHours").value)||0;
    if(!pupils[index].lessons) pupils[index].lessons=[];
    pupils[index].lessons.push({
        date:new Date().toLocaleDateString(),
        hours,
        goal:document.getElementById("goal").value,
        well:document.getElementById("well").value,
        improve:document.getElementById("improve").value,
        achieved:document.getElementById("achieved").value,
        additional:document.getElementById("additional").value,
        scale1:getScaleValue("scale1"),
        scale2:getScaleValue("scale2")
    });
    pupils[index].totalHours=(pupils[index].totalHours||0)+hours;
    localStorage.setItem("pupils",JSON.stringify(pupils));
    updateHours();
    alert("Lesson saved.");
}

/* ADD/DELETE PUPIL */
function addPupil(){
    const name=prompt("Enter pupil name:");
    if(!name) return;
    const email=prompt("Enter pupil email:");
    pupils.push({name,email,totalHours:0,lessons:[]});
    localStorage.setItem("pupils",JSON.stringify(pupils));
    refreshPupils();
}
function deletePupil(){
    const index=pupilSelect.value;
    if(index==="") return;
    pupils.splice(index,1);
    localStorage.setItem("pupils",JSON.stringify(pupils));
    refreshPupils();
}
pupilSelect.addEventListener("change",updateHours);

/* PDF + SHARE */
function generatePDFandShare(){
    const index=pupilSelect.value;
    if(index==="") return alert("Select pupil.");
    const pupil=pupils[index];
    if(!pupil.email) return alert("No email stored.");

    const element=document.getElementById("formArea");
    const opt={margin:0.5,filename:`${pupil.name.replace(/\s+/g,"_")}_lesson.pdf`,image:{type:'jpeg',quality:0.98},html2canvas:{scale:2},jsPDF:{unit:'in',format:'a4',orientation:'portrait'}};
    html2pdf().set(opt).from(element).save().then(()=>{
        const subject=encodeURIComponent("Driving Lesson Reflection");
        const body=encodeURIComponent("Please find attached the lesson reflection PDF.");
        window.location.href=`mailto:${pupil.email}?subject=${subject}&body=${body}`;
    });
}
</script>

</body>
</html>