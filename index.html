<script>
// ... (keep all your existing functions: save, loadDropdown, addPupil, deletePupil, updateDisplay, createScale, saveLessonData)

async function generateLessonPDF(){
    if(!currentPupil){alert("Select a pupil first.");return;}
    saveLessonData();

    let buttons = document.querySelectorAll(".hidden-print");
    buttons.forEach(b => b.style.display = "none");

    // Replace textareas with pre elements to preserve newlines
    let textareas = document.querySelectorAll('#formArea textarea');
    let replacements = [];
    textareas.forEach(ta => {
        let pre = document.createElement('pre');
        pre.style.cssText = ta.style.cssText + '; white-space: pre-wrap; word-wrap: break-word; min-height:80px; border:1px solid #ccc; padding:10px; border-radius:8px; background:white; font-family: Arial; font-size:16px;';
        pre.textContent = ta.value;
        ta.parentNode.insertBefore(pre, ta);
        ta.style.display = 'none';
        replacements.push({ta, pre});
    });

    let canvas = await html2canvas(document.getElementById("formArea"), {scale: 2});

    // Restore textareas
    replacements.forEach(({ta, pre}) => {
        ta.style.display = '';
        pre.remove();
    });

    const { jsPDF } = window.jspdf;
    let pdf = new jsPDF("p", "mm", "a4");

    let pageWidth  = pdf.internal.pageSize.getWidth();
    let pageHeight = pdf.internal.pageSize.getHeight();

    let imgWidth  = pageWidth;
    let imgHeight = canvas.height * imgWidth / canvas.width;

    let pageCanvas = document.createElement("canvas");
    let ctx = pageCanvas.getContext("2d");

    let pageHeightPx = canvas.width * pageHeight / pageWidth;
    let totalPages = Math.ceil(canvas.height / pageHeightPx);

    for(let i = 0; i < totalPages; i++){
        pageCanvas.width = canvas.width;
        pageCanvas.height = pageHeightPx;

        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, pageCanvas.width, pageCanvas.height);
        ctx.drawImage(canvas, 0, i * pageHeightPx, canvas.width, pageHeightPx, 0, 0, canvas.width, pageHeightPx);

        if(i > 0) pdf.addPage();
        pdf.addImage(pageCanvas.toDataURL("image/png"), "PNG", 0, 0, imgWidth, imgHeight);
    }

    // Get PDF as blob
    let pdfBlob = pdf.output('blob');
    let pdfUrl = URL.createObjectURL(pdfBlob);

    // Prepare email content
    let today = new Date().toLocaleDateString('en-GB', {day:'numeric', month:'long', year:'numeric'});
    let subject = `Reflective Log – ${currentPupil} – ${today}`;
    let body = `Dear recipient,

Please find attached the reflective log for ${currentPupil} dated ${today}.

You can also download/view it here: ${pdfUrl}

Best regards,
Alex Heirani`;

    // Create mailto link with attachment support (some clients respect it)
    let mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

    // Offer both: direct mailto + manual download
    let choice = confirm(
        "PDF generated!\n\n" +
        "Would you like to open your email client to send it?\n\n" +
        "→ Yes = opens email with subject & body (attachment may work in some clients)\n" +
        "→ No = just downloads the PDF (you can attach it manually)"
    );

    if(choice){
        // Try to trigger mailto
        window.location.href = mailtoLink;

        // Also offer download as fallback / extra copy
        let a = document.createElement('a');
        a.href = pdfUrl;
        a.download = `Reflective_Log_${currentPupil}_${today.replace(/ /g,'_')}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    } else {
        // Just download
        let a = document.createElement('a');
        a.href = pdfUrl;
        a.download = `Reflective_Log_${currentPupil}_${today.replace(/ /g,'_')}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    buttons.forEach(b => b.style.display = "block");

    // Optional: clean up blob URL after some time
    setTimeout(() => URL.revokeObjectURL(pdfUrl), 60000);
}

// Add a new button for emailing (you can place this wherever you like)
function addEmailButton(){
    let div = document.querySelector(".hidden-print");
    if(!div.querySelector('#emailBtn')){
        let btn = document.createElement("button");
        btn.id = "emailBtn";
        btn.innerText = "Generate & Email Reflective Log";
        btn.onclick = generateLessonPDF;
        btn.style.background = "#0066cc";
        div.appendChild(btn);
    }
}

// Call this after load
window.addEventListener('load', () => {
    loadDropdown();
    addEmailButton();
});

// ... keep your exportHistoryPDF() function as is
</script>